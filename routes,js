const express = require('express');
const passport = require('passport');
const { pitchController, bookingController, authController } = require('./controllers');
const { requireLogin, requireAdmin, requireManager } = require('./middleware');
const config = require('./config');

const router = express.Router();

// Routes العامة
router.get('/pitches', pitchController.getAllPitches);
router.get('/pitches/:id', pitchController.getPitchById);
router.get('/pitches/:id/available-slots', pitchController.getAvailableSlots);

// Routes المصادقة
router.post('/signup', authController.signup);
router.post('/login', authController.login);
router.post('/logout', authController.logout);

// Google OAuth Routes
router.get('/auth/google', passport.authenticate('google', { 
  scope: ['profile', 'email'] 
}));

router.get('/auth/google/callback', 
  passport.authenticate('google', { 
    failureRedirect: '/login',
    failureMessage: 'فشل التسجيل باستخدام جوجل' 
  }),
  (req, res) => {
    req.session.user = {
      id: req.user.id,
      username: req.user.username,
      email: req.user.email,
      phone: req.user.phone,
      role: req.user.role
    };
    res.redirect('/profile');
  }
);

// Routes الحجوزات (تتطلب تسجيل دخول)
router.get('/user/bookings', requireLogin, bookingController.getUserBookings);
router.post('/bookings', requireLogin, bookingController.createBooking);
router.put('/bookings/:id/cancel', requireLogin, bookingController.cancelBooking);

// Routes الإدارة (تتطلب صلاحيات مدير)
router.get('/admin/stats', requireAdmin, (req, res) => {
  // كود الإحصائيات
});

router.get('/admin/bookings', requireAdmin, (req, res) => {
  // كود حجوزات المدير
});

// Routes المديرين
router.get('/manager/pitches', requireManager, (req, res) => {
  // كود ملاعب المدير
});

router.get('/manager/bookings', requireManager, (req, res) => {
  // كود حجوزات المدير
});

module.exports = router;
